# handlers/privacy.py
"""
隐私政策处理模块
处理隐私政策查询功能
"""

from telegram import Update
from telegram.ext import CallbackContext

async def privacy_command(update: Update, context: CallbackContext):
    """处理 /privacy 命令
    
    Args:
        update: Telegram update 对象
        context: Telegram context 对象
    """
    privacy_text = (
        "🔒 <b>KENNEL 隐私政策</b>\n\n"
        "<b>最后更新日期：2025年9月7日</b>\n"
        "<b>生效日期：2025年9月7日</b>\n\n"

        "欢迎使用 KENNEL 投稿机器人服务。我们高度重视您的隐私权，请仔细阅读本隐私政策，"
        "了解我们如何收集、使用、存储和保护您的个人信息。\n\n"

        "📋 <b>1. 信息收集</b>\n"
        "我们遵循最小必要原则，收集的信息包括：\n"
        "• <b>账户信息</b>：用户ID、用户名、语言设置等 Telegram 平台提供的基本信息\n"
        "• <b>投稿内容</b>：您主动提交的文本内容\n"
        "• <b>媒体文件ID</b>：您提交的照片、视频、音频等媒体文件的 Telegram 文件ID（file_id）\n"
        "  • <b>重要说明</b>：我们<b>不储存</b>您的照片、视频或音频文件本身，这些文件由 Telegram 服务器保存\n"
        "  我们只保存 Telegram 提供的文件ID，用于后续在频道中展示或转发内容\n"
        "• <b>交互数据</b>：您使用机器人功能的时间、频率、操作记录\n"
        "• <b>设备信息</b>：设备类型、操作系统（用于优化服务体验）\n"
        "• <b>网络信息</b>：IP地址（用于安全防护和合规要求）\n\n"

        "🛠️ <b>2. 信息使用</b>\n"
        "我们严格按照收集目的使用您的信息：\n"
        "• 处理和管理您的投稿内容，包括审核、发布和存档\n"
        "• 提供客户支持和问题解答服务\n"
        "• 改进机器人服务质量，优化用户体验\n"
        "• 确保平台安全，防止欺诈、滥用和恶意行为\n"
        "• 履行法律法规要求和合规义务\n"
        "• 向您发送服务相关的重要通知\n\n"

        "🔐 <b>3. 信息保护</b>\n"
        "KENNEL 管理组采取业界标准的安全措施：\n"
        "• 采用端到端加密技术保护数据传输\n"
        "• 实施严格的访问控制，仅授权人员可访问必要信息\n"
        "• 定期进行安全审计和漏洞扫描\n"
        "• 建立数据备份和灾难恢复机制\n"
        "• 对员工进行隐私保护培训\n"
        "• 实施数据分类分级管理\n\n"

        "🤝 <b>4. 信息共享与披露</b>\n"
        "我们严格控制信息共享，仅在以下情形披露：\n"
        "• <b>内容发布</b>：通过审核的投稿内容会在 KENNEL 频道和群组中公开发布\n"
        "• <b>团队协作</b>：必要信息在 KENNEL 授权管理员和审核员间共享\n"
        "• <b>法律要求</b>：应法律法规、司法程序或政府主管部门要求\n"
        "• <b>服务提供</b>：与可信的服务提供商合作，但须签署保密协议\n"
        "• <b>权益保护</b>：为保护我们或他人的合法权益、财产安全或安全\n\n"

        "📊 <b>5. 数据保留与删除</b>\n"
        "我们按照以下原则管理数据保留：\n"
        "• 投稿内容：为维持服务连续性长期保留，但您可随时请求删除\n"
        "• 个人身份信息：在您使用服务期间持续保留\n"
        "• 媒体文件ID：发布后30天内自动清理\n"
        "• 日志信息：保留6个月后自动删除（法律法规另有要求的除外）\n"
        "• 您可随时请求删除您的个人信息，我们将在15个工作日内响应\n\n"

        "👤 <b>6. 您的权利</b>\n"
        "根据相关法律法规，您享有以下权利：\n"
        "• <b>知情权</b>：了解我们如何处理您的个人信息\n"
        "• <b>访问权</b>：查询我们持有的您的个人信息\n"
        "• <b>更正权</b>：更正不准确或不完整的个人信息\n"
        "• <b>删除权</b>：在符合法律规定的情况下请求删除个人信息\n"
        "• <b>限制处理权</b>：在特定情况下限制我们处理您的信息\n"
        "• <b>数据可携带权</b>：在技术上可行的情况下获取您的数据副本\n"
        "• <b>撤回同意权</b>：随时撤回对我们处理您信息的同意\n"
        "• <b>投诉权</b>：向相关监管部门投诉我们的隐私实践\n\n"

        "🌐 <b>7. 跨境数据传输</b>\n"
        "如发生跨境数据传输，我们将：\n"
        "• 确保接收方提供同等水平的数据保护\n"
        "• 遵守相关法律法规对跨境传输的要求\n"
        "• 采取必要的技术和管理措施保障数据安全\n\n"

        "👶 <b>8. 未成年人保护</b>\n"
        "我们重视对未成年人个人信息的保护：\n"
        "• 未满14周岁的用户应在监护人指导下使用服务\n"
        "• 如我们发现无意中收集了未成年人信息，将尽快删除\n"
        "• 监护人有权随时查看、更正或删除未成年人信息\n\n"

        "⚖️ <b>9. 争议解决</b>\n"
        "如对隐私实践有争议，您可以通过以下途径解决：\n"
        "• 首先通过上述联系方式与我们协商解决\n"
        "• 向相关监管部门投诉或举报\n"
        "• 通过法律途径维护您的合法权益\n\n"

        "⚖️ <b>10. 法律适用与管辖</b>\n"
        "本隐私政策受以下法律法规约束：\n"
        "• <b>中华人民共和国法律</b>：适用于中国大陆用户\n"
        "• <b>新加坡法律</b>：适用于服务器运营及数据存储相关事务\n"
        "  - 个人数据保护法(PDPA)：规范个人数据收集、使用、披露和管理\n"
        "  - 网络安全法：确保网络系统安全和数据保护\n"
        "  - 电子交易法：规范电子交易的合法性和安全性\n"
        "  - 计算机滥用法：防止未经授权的计算机访问和数据泄露\n"
        "• <b>国际最佳实践</b>：参考GDPR等国际标准制定隐私保护措施\n"
        "• 如不同法律法规存在冲突，我们将遵循更严格的标准保护您的权益\n\n"

        "🇸🇬 <b>11. 新加坡数据保护特别条款</b>\n"
        "由于我们的服务器位于新加坡，您同意：\n"
        "• 您的个人信息可能被传输至新加坡并存储在当地数据中心\n"
        "• 我们遵守新加坡个人数据保护法(PDPA)的所有要求\n"
        "• 新加坡通讯及新闻部(MCI)和个人数据保护委员会(PDPC)对我们的数据处理活动具有监管权\n"
        "• 如发生数据泄露事件，我们将按PDPA要求在72小时内向PDPC报告\n"
        "• 您有权就我们违反PDPA的行为向新加坡PDPC投诉\n\n"

        "🖼️ <b>12. 媒体文件处理特别说明</b>\n"
        "关于您投稿的照片、视频和音频文件，我们特别声明：\n"
        "• <b>不储存原文件</b>：我们<b>不会</b>下载、保存或缓存您的原始媒体文件\n"
        "• <b>只保存文件ID</b>：我们只保存 Telegram 提供的 file_id，用于在频道中展示或转发您的投稿\n"
        "• <b>文件存储方</b>：所有媒体文件实际存储在 Telegram 的云服务器中，受 Telegram 的隐私政策和安全措施保护\n"
        "• <b>文件访问</b>：我们可以通过 file_id 从 Telegram 服务器获取文件以进行展示，但不会在本地保留副本\n"
        "• <b>数据安全</b>：您的媒体文件安全由 Telegram 负责，我们仅负责管理投稿内容和文件ID的对应关系\n\n"

        "🗑️ <b>13. 第三方删除请求处理</b>\n"
        "当被投稿人要求删除涉及其相关内容的投稿时：\n"
        "• <b>身份验证</b>：我们将要求被投稿人提供充分证据验证其身份\n"
        "• <b>关系证明</b>：被投稿人需证明其与要求删除内容的直接关系\n"
        "• <b>合理性审查</b>：我们将评估删除请求的合理性和合法性\n"
        "• <b>信息提供</b>：如情况属实且符合法律规定，我们将向被投稿人提供投稿人的用户ID\n"
        "• <b>例外情况</b>：如投稿内容涉及公共利益或法律规定不得删除的情形，我们可能拒绝删除请求\n"
        "• <b>争议处理</b>：如投稿人和被投稿人存在争议，我们建议通过法律途径解决\n"
        "• <b>记录保存</b>：所有删除请求和处理记录将保存3年备查\n\n"

        "🔄 <b>14. 政策更新与通知</b>\n"
        "我们可能会根据业务发展或法律法规变化更新本政策：\n"
        "• 重大变更将通过机器人消息或频道公告通知您\n"
        "• 更新后的政策将在生效前至少7天公布\n"
        "• 建议您定期查看 /privacy 获取最新版本\n"
        "• 继续使用服务即表示接受更新后的政策\n\n"

        "📞 <b>15. 联系我们</b>\n"
        "如有任何隐私相关问题或要行使您的权利，请通过以下方式联系：\n"
        "• Telegram：通过机器人发送 /contact 命令\n"
        "• 频道留言：在 KENNEL 官方频道留言\n"
        "• 邮件留言： KENNEL-CN@TUTA.IO\n"
        "• 群组反馈：在官方群组提出您的问题\n"
        "我们将在收到后48小时内回复您的请求\n\n"

        "<b>感谢您信任并使用 KENNEL 投稿机器人服务！</b>\n"
        "<b>我们承诺持续改进隐私保护措施，为您提供安全可靠的服务体验。</b>"
    )
    
    # 获取正确的消息对象（处理回调查询的情况）
    message = None
    if update.message is not None:
        message = update.message
    elif update.callback_query is not None and update.callback_query.message is not None:
        message = update.callback_query.message
    
    if message is None:
        return
    
    # 发送隐私政策，如果消息太长就分开发送
    max_length = 4096
    if len(privacy_text) <= max_length:
        await message.reply_text(privacy_text, parse_mode='HTML')
    else:
        # 分割消息
        parts = []
        current_part = ""
        
        for paragraph in privacy_text.split('\n\n'):
            if len(current_part) + len(paragraph) + 2 > max_length:
                parts.append(current_part)
                current_part = paragraph
            else:
                if current_part:
                    current_part += '\n\n' + paragraph
                else:
                    current_part = paragraph
        
        if current_part:
            parts.append(current_part)
        
        for i, part in enumerate(parts, 1):
            if i == 1:
                await message.reply_text(part, parse_mode='HTML')
            else:
                # 后续消息作为回复发送
                await message.reply_text(part, parse_mode='HTML')